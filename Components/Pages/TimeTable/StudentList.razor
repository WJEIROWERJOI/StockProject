@page "/TimeTable/Student"


@inject IToastService toastService
@inject IModalService modalService
@inject StudentService studentService
@inject NavigationManager nav

<PageTitle>StudentList</PageTitle>
<h3>🎓StudentList</h3>
<hr />

<button class="btn btn-primary" type="button" @onclick="StudentCreateModal">학생 등록</button>
<br />

@* <div style="display:flex;justify-content: flex-end;"> *@
<div stlye="display:flex; justify-content:flex-start;" class="mt-3">
    <div class="input-group" style="max-width: fit-content;">


        <select @bind=@searchTopic class="form-select form-select-sm">
            <option value="Name">Name</option>
            <option value="StudentGrade">StudentGrade</option>
        </select>

        @if (searchTopic is "StudentGrade")
        {
            <select @bind="@searchContent" class="form-select form-select-sm">
                @foreach (var group in Enum.GetValues(typeof(StudentGrade)))
                {
                    <option value="@group">@group</option>
                }
            </select>
        }
        else
        {
            <InputText @bind-Value="@searchContent" class="form-control" />
        }

        <button type="button" @onclick="StartSearch" class="btn btn-secondary">검색</button>
        <button @onclick="CancelSearch" class="btn btn-secondary border-start-1">취소</button>

    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? searchTopic { get; set; }
    [SupplyParameterFromQuery]
    public string? searchContent { get; set; }


    private void StartSearch()
    {
        ///TimeTable/Student
        nav.NavigateTo($"/TimeTable/Student?searchTopic={searchTopic}&searchContent={searchContent}", forceLoad: true);
    }

    private void CancelSearch()
    {
        searchContent = "";
        // searchTopic = "";
        nav.NavigateTo($"/TimeTable/Student?");
    }
}


@if (students is null)
{
    <p>Loading...</p>
}
else
{
    <div class="table-responsive d-flex justify-content-between align-items-center mb-3 mt-3">
        <table class="table table-striped table-bordered table-hover align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th scope="col">학생이름</th>
                    <th scope="col">학년</th>
                    <th scope="col">반</th>
                    <th scope="col">설명</th>
                    <th scope="col">버튼</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var student in students)
                {
                    <tr @onclick="() => DetailStudentModal(student)">

                        <td>@student.Name</td>
                        <td>@student.StudentGrade.ToString()</td>
                        <td>@student.Class?.Name</td>
                        <td>@student.Description</td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" @onclick:stopPropagation @onclick="() => DeleteStudent(student.Id)">삭제</button>
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
}

@code {
    List<Student> students = new();
    protected override async Task OnInitializedAsync()
    {
        var result = await studentService.GetAllStudentsAsync();
        if (result.Success && result.Data is not null)
        {
            students = result.Data;
        }
        else
        {
            toastService.ShowError(result.Message!);
        }
    }
    async Task StudentCreateModal()
    {
        var modal = modalService.Show<StudentCreateModal>("Create Student");
        var result = await modal.Result;
        if (!result.Cancelled)
        {
            if (result.Data is bool success)
            {
                // students = await studentService.GetAllStudentsAsync();
                // 다시 받아 오는거 필요
                toastService.ShowSuccess("학생 생성!");
            }

        }
    }
    async Task DetailStudentModal(Student student)
    {
        var parameter = new ModalParameters();
        parameter.Add(nameof(StudentDetailModal.student), student);

        var modal = modalService.Show<StudentDetailModal>("Detail Student", parameter);
        var result = await modal.Result;
        if (!result.Cancelled)
        {
            if (result.Data is bool success)
            {
                toastService.ShowSuccess("학생 관리!");
            }
        }

    }
    async Task DeleteStudent(int id)
    {
        var modal = modalService.Show<ConfirmModal>();
        var result = await modal.Result;
        if (!result.Cancelled)
        {
            if (result.Data is bool success)
            {
                if((await studentService.DeleteStudentAsync(id)).Success)
                {
                    toastService.ShowSuccess("삭제 성공!");
                }
                else
                {
                    toastService.ShowError("삭제 실패!");
                }
            }
        }
        else
        {
            toastService.ShowInfo("삭제 취소!");
        }
    }

}

